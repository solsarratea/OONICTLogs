# OONICTLogs
Project intended to:
- learn GO [**]
- collect all certificate chains from the webconnectivity OONI measurements to create Certificate Transparency logs, using the Letâ€™s Encrypt testing Twig logs as a target.

**WARNING:** It was a rapid prototyping, still did not get a successfull reply from submission to Twig.

## How to: 
### Build
Set parameters on the `config.json` and run <br>
`GO111MODULE=auto build -o service main.go` <br>
`./servcice`

### Develop
There are 2 flags for enabling/disabling go-routines
+ running both:  `GO111MODULE=auto run main.go` 
+ run proccess to find certificate chains: `GO111MODULE=auto run main.go find`  
+ run rpocess for submit certchain: `GO111MODULE=auto run main.go submit`
  
**RECOMENDATION:** running processes independently allows better workflow while testing. **submit** currently has a very slow rate to prevent multiple POSTS.


### Tests
Unit tests in some packages by running the command: `GO111MODULE=auto test`


## Project structure
It is structured using 2 go-routines :D

**WHY?** It is a nice way of sharing memory and being able to handle different time-rates. 

### Goroutine: Finder
Queries and processes all measurements to extract the certificate chains for submission. <br/>
**How?** <br/>

+ Loads root certificates from Twig. <br/>
+ Get raw measurments from OONI and write collection of single measurement into *raw_measurements.txt*. <br/>
+ Process each measurement. <br/>
++ Read from *raw_measurements.txt* and process each URL: <br/>
+++ Query single measurement to OONI <br/>
+++ Parse it and get Certificate Chain <br/>
+++ Look for Root Certificate and write valid cert chain into local directory [*] <br/>
+++ Delete entry from the *raw_measurements.txt* <br/>

### Goroutine: Submitter
+ Read availables JSON generated by `finder`.
+ Submits the certificate chains into Twig.

## Improve/TODOs (sorted by priority):
~- Update config.json automatically after processing all measurments (last certifiate update since)~
- Improve certificate chain validation:
 - Check intermediate certs are resolving to parents.
 - Only principal cert should look for its root.
 - Check if already submitted by using the signature field:
 ["Using the signature field, we can verify that the certificate was submitted to a log. Using our SCT deep dive guide, you could further decode this value."](https://letsencrypt.org/docs/ct-logs/#Sunlight)

- Improve log system: specially for submitter.
- Research on async functions, improve function calls and concurrency
- Do not allow read/write at same time !! (it was OK for testing)
- `raw_measurements.txt` proabably be replaced for a stack (it was also OK for testing)
- Automatically update the Twig CTLog according to date/time window
https://letsencrypt.org/docs/ct-logs/#Sunlight
- `utils/` will probably dissappear/be moved to `/common` though was very useful for interacting with APIs during devlopment



#### [*] Valid certificate chains:
From RFC 6962:
- Each submitted certificate MUST be accompanied by all additional certificates required to verify the certificate chain up to an accepted root certificate.

#### [**]
![](https://upload.wikimedia.org/wikipedia/commons/thumb/2/23/Golang.png/320px-Golang.png)
